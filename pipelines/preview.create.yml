resources:
  repositories:
    - repository: templates
      type: github
      name: expensely/azure-devops-templates
      endpoint: expensely

trigger: none

pr:
  branches:
    include:
      - 'main'

pool:
  vmImage: ubuntu-latest

variables:
  - template: variables/preview.ap-southeast-2.yml@templates

stages:
  - stage: build
    displayName: Build
    jobs:
      - job: setup
        displayName: Setup
        steps:
          - checkout: none
          - template: templates/build.numbers.yml
      - job: api
        displayName: Api
        dependsOn:
          - setup
        steps:
          - template: templates/build.api.yml
          - template: aws/iam/configure.yml@templates
          - template: templates/push.api.yml
      - job: integration_tests
        displayName: Integration Tests
        dependsOn:
          - setup
        variables:
          NPM_BUILD_NUMBER: $[ dependencies.setup.outputs['setNPMBuildIdentifier.NPMBuildNumber'] ]
        steps:
          - template: templates/build.integration-tests.yml
            parameters:
              buildNumber: $(NPM_BUILD_NUMBER)
          - template: aws/iam/configure.yml@templates
          - template: templates/push.integration-tests.yml
            parameters:
              buildNumber: $(NPM_BUILD_NUMBER)

  - stage: preview
    displayName: Preview
    dependsOn:
      - build
    variables:
      - name: ARTIFACT_NAME
        value: preview.terraform
        readonly: true
      - name: NPM_BUILD_NUMBER
        value: $[ stageDependencies.build.setup.outputs['setNPMBuildIdentifier.NPMBuildNumber'] ]
    jobs:
      - job: plan
        displayName: Plan
        steps:
          - template: aws/iam/configure.yml@templates
          - template: terraform/plan.yml@templates
            parameters:
              artifactName: $(ARTIFACT_NAME)
              workspaceName: service-time-$(ENVIRONMENT)$(System.PullRequest.PullRequestNumber)
              planAdditionalCommandOptions: '-var-file="variables/$(ENVIRONMENT).$(REGION).tfvars" -var="build_identifier=$(Build.BuildNumber)" -var="environment=Preview$(System.PullRequest.PullRequestNumber)" -var="subdomain=time$(System.PullRequest.PullRequestNumber)" -var="npm_build_identifier=$(NPM_BUILD_NUMBER)"'
      - deployment: deploy
        displayName: Deploy
        dependsOn:
          - plan
        environment: preview
        strategy:
          runOnce:
            deploy:
              steps:
                - download: none
                - template: aws/iam/configure.yml@templates
                - template: terraform/apply.yml@templates
                  parameters:
                    artifactName: $(ARTIFACT_NAME)
                - template: aws/codedeploy/deploy.yml@templates
                  parameters:
                    appSpecFileName: $(Build.BuildNumber).yaml
                    destinationPath: time/$(ENVIRONMENT)$(System.PullRequest.PullRequestNumber)
                - template: aws/s3/publish-test-results.yml@templates
                  parameters:
                    sourcePath: time/$(ENVIRONMENT)$(System.PullRequest.PullRequestNumber)
                    testResultsFileName: $(NPM_BUILD_NUMBER).xml
                    testRunTitle: Integration
